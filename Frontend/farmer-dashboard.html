<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Farmer Dashboard — Krishi Mitra</title>
  <link rel="stylesheet" href="index.css" />
  <link rel="stylesheet" href="farmer-dashboard.css" />

</head>
<body>
  <!-- Navbar -->
  <div class="navbar animate">
    <h1 class="logo animate">Krishi Mitra</h1>
    <button class="menu-toggle" onclick="toggleMenu()">☰</button>
    <div class="nav-links animate" id="navLinks">
      <a href="my-account.html">My Account</a>
      <a href="whether-details.html">Weather</a>
      <a href="schemes.html">Schemes</a>
      <a href="">Logout</a>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard-container">
    <h2>🌾 Welcome to Your Dashboard</h2>
    <div id="location-info">Fetching your location...</div>
    <button class="refresh-btn" onclick="fetchSeedPrices()">🔄 Refresh Prices</button>

    <div class="price-grid" id="priceGrid">
      <!-- Prices will appear here -->
    </div>
  </div><br><br><br>

  <!-- 🌾 Crop Disease Detection Knowledge -->
<section class="disease-carousel">
  <h3>🧫 Crop Disease Detection & Awareness</h3>

  <div class="carousel-container">
    <div class="carousel-track" id="diseaseTrack">
      <div class="disease-slide">
        <img src="src/assets/wheat rust.jpeg" alt="Wheat Rust">
        <h4>Wheat — Rust Disease</h4>
        <p style="text-align: center;">Caused by fungi <i>Puccinia</i>. Orange pustules on leaves and stems.  
        <b>Prevention:</b> Use resistant wheat varieties & proper irrigation management.</p>
      </div>

      <div class="disease-slide">
        <img src="src/assets/Rice blast.jpg" alt="Rice Blast">
        <h4>Rice — Blast Disease</h4>
        <p style="text-align: center;">Caused by <i>Magnaporthe oryzae</i>. Diamond spots on leaves and necks.  
        <b>Prevention:</b> Use clean seeds & spray tricyclazole fungicide.</p>
      </div>

      <div class="disease-slide">
        <img src="src/assets/Maze Downy Mildew.jpg" alt="Maize Leaf Blight">
        <h4>Maize — Leaf Blight</h4>
        <p style="text-align: center;">Caused by <i>Exserohilum turcicum</i>. Brown lesions appear along leaf veins.  
        <b>Prevention:</b> Crop rotation & Mancozeb spray recommended.</p>
      </div>

      <div class="disease-slide">
        <img src="src/assets/Cotton Alternaria Leaf Spot.webp" alt="Cotton — Alternaria Leaf Spot">
        <h4>Cotton — Alternaria Leaf Spot</h4>
        <p style="text-align: center;">Bacteria/fungi infection turning bolls brown and soft.  
        <b>Prevention:</b> Maintain field hygiene & use carbendazim fungicide.</p>
      </div>

      <div class="disease-slide">
        <img src="src/assets/Potato Late Blight.jpeg" alt="Potato Late Blight">
        <h4>Potato — Late Blight</h4>
        <p style="text-align: center;">Caused by <i>Phytophthora infestans</i>. Blackish leaf spots & tuber rot.  
        <b>Prevention:</b> Avoid water stagnation & apply copper fungicides.</p>
      </div>
    </div>

    <!-- Navigation buttons -->
    <button class="carousel-btn prev" onclick="prevSlide()">❮</button>
    <button class="carousel-btn next" onclick="nextSlide()">❯</button>
  </div>
</section><br><br>

<!-- 🌿 Fertilizer Recommendation System -->
<section class="fertilizer-section">
  <h3>🌿 Fertilizer Recommendation System</h3>
  <p>Select your crop details to get tailored fertilizer and nutrient advice.</p>

  <div class="fertilizer-form">
    <label for="crop">Crop Name:</label>
    <select id="crop">
      <option value="">-- Select Crop --</option>
      <option value="wheat">Wheat</option>
      <option value="rice">Rice</option>
      <option value="maize">Maize</option>
      <option value="cotton">Cotton</option>
      <option value="potato">Potato</option>
      <option value="soybean">Soybean</option>
    </select>

    <label for="soil">Soil Type:</label>
    <select id="soil">
      <option value="">-- Select Soil Type --</option>
      <option value="loamy">Loamy</option>
      <option value="sandy">Sandy</option>
      <option value="clay">Clay</option>
    </select>

    <label for="ph">Soil pH Level:</label>
    <input type="number" id="ph" min="3" max="10" step="0.1" placeholder="e.g., 6.5" />

    <button onclick="getFertilizerRecommendation()">🌾 Get Recommendation</button>
  </div>

  <div id="fertilizerOutput" class="fertilizer-output"></div>

  <canvas id="fertilizerChart" style="max-width: 500px; margin: 30px auto; display: none;"></canvas>

  <button id="downloadPDFBtn" class="download-btn" style="display: none;">📄 Download as PDF</button>
</section>

<!-- 📊 Chart.js & 📑 jsPDF CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- 📍 Nearby Agricultural Services Section -->
<section class="nearby-services-section">
  <h3>📍 Nearby Agricultural Services</h3>
  <p>Find fertilizer shops, mandis, cold storages, and Krishi Kendras around you.</p>
  <div id="map" style="width:100%; height:450px; border-radius:10px;"></div>
</section>

<!-- Leaflet CSS + JS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


<button id="chatbot-btn">💬</button>

<div id="chatbot-window">
  <div id="chat-header">Krishi Mitra AI</div>
  <div id="chat-messages"></div>
  <div id="chat-input">
    <input type="text" id="user-input" placeholder="Type your question..." />
    <button id="send-btn">Send</button>
  </div>
</div>

  <footer>© 2025 Krishi Mitra | Empowering Farmers with Technology 🌱</footer>

  <script>
    async function fetchSeedPrices() {
      const priceGrid = document.getElementById("priceGrid");
      priceGrid.innerHTML = "<p>Loading latest prices...</p>";

      try {
        // Simulated seed price data — replace later with real API
        const mockData = [
          { crop: "Wheat", price: "₹2,150 / quintal" },
          { crop: "Rice", price: "₹2,800 / quintal" },
          { crop: "Maize", price: "₹1,950 / quintal" },
          { crop: "Pulses", price: "₹5,000 / quintal" },
          { crop: "Groundnut", price: "₹6,200 / quintal" },
          { crop: "Soybean", price: "₹4,850 / quintal" }
        ];

        // Simulate delay
        await new Promise(res => setTimeout(res, 1000));

        // Display prices
        priceGrid.innerHTML = mockData.map(item => `
          <div class="price-card">
            <div class="crop-name">${item.crop}</div>
            <div class="crop-price">Current Price: ${item.price}</div>
          </div>
        `).join("");
      } catch (err) {
        priceGrid.innerHTML = "<p style='color:red;'>Failed to load seed prices. Try again.</p>";
        console.error(err);
      }
    }

    // Get user's location
    function getUserLocation() {
      const locInfo = document.getElementById("location-info");
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          async position => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            try {
              const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
              const data = await res.json();
              const locationName = `${data.city || data.locality || "Your Area"}, ${data.principalSubdivision}`;
              locInfo.textContent = `📍 Location: ${locationName}`;
            } catch {
              locInfo.textContent = "📍 Location detected, but could not fetch name.";
            }
            fetchSeedPrices();
          },
          () => {
            locInfo.textContent = "📍 Unable to access location. Showing general prices.";
            fetchSeedPrices();
          }
        );
      } else {
        locInfo.textContent = "📍 Location not supported by your browser.";
        fetchSeedPrices();
      }
    }

    // Navbar toggle
    function toggleMenu() {
      document.getElementById("navLinks").classList.toggle("show");
    }

    // Initialize
    getUserLocation();

    // 🌿 Crop Disease Carousel Script
const track = document.getElementById("diseaseTrack");
let currentIndex = 0;
const slides = document.querySelectorAll(".disease-slide");

function updateSlide() {
  track.style.transform = `translateX(-${currentIndex * 100}%)`;
}

function nextSlide() {
  currentIndex = (currentIndex + 1) % slides.length;
  updateSlide();
}

function prevSlide() {
  currentIndex = (currentIndex - 1 + slides.length) % slides.length;
  updateSlide();
}

// Auto-slide every 5 seconds
setInterval(nextSlide, 5000);

let fertilizerChart = null;

async function getFertilizerRecommendation() {
  const crop = document.getElementById("crop").value;
  const soil = document.getElementById("soil").value;
  const ph = parseFloat(document.getElementById("ph").value);
  const outputDiv = document.getElementById("fertilizerOutput");
  const chartCanvas = document.getElementById("fertilizerChart");
  const downloadBtn = document.getElementById("downloadPDFBtn");

  if (!crop || !soil || isNaN(ph)) {
    outputDiv.innerHTML = "<p style='color:red;'>⚠️ Please fill in all details to get a recommendation.</p>";
    chartCanvas.style.display = "none";
    downloadBtn.style.display = "none";
    return;
  }

  const recommendations = {
    wheat: { npk: "120:60:40", schedule: "Basal: ½ N + full P + full K, Topdress: ½ N at tillering", organic: "Compost + Vermicompost" },
    rice: { npk: "100:50:50", schedule: "Basal: ⅔ N + full P + full K, Topdress: ⅓ N at panicle initiation", organic: "Green manure + Cow dung slurry" },
    maize: { npk: "150:75:40", schedule: "Basal: ½ N + full P + full K, Topdress: ½ N at knee-high stage", organic: "Biofertilizer + Neem cake" },
    cotton: { npk: "80:40:40", schedule: "Basal: full P + full K, Topdress: N in 2 equal splits", organic: "Compost + Azospirillum" },
    potato: { npk: "120:100:120", schedule: "Basal: ½ N + full P + ½ K, Topdress: Remaining N & K after 30 days", organic: "Farmyard manure + Bone meal" },
    soybean: { npk: "20:60:40", schedule: "Basal: full dose before sowing", organic: "Rhizobium culture + Compost" }
  };

  const rec = recommendations[crop];
  const npkValues = rec.npk.split(":").map(Number);

  let soilAdjust = "";
  if (ph < 6) soilAdjust = "🧪 Acidic soil detected — add lime before sowing.";
  else if (ph > 7.5) soilAdjust = "🧪 Alkaline soil — add gypsum or organic matter to balance pH.";
  else soilAdjust = "✅ Soil pH optimal for nutrient absorption.";

  outputDiv.innerHTML = `
    <h4>🌾 Recommended Fertilizer Plan for ${crop.charAt(0).toUpperCase() + crop.slice(1)}</h4>
    <ul>
      <li><b>Soil Type:</b> ${soil}</li>
      <li><b>Soil pH:</b> ${ph}</li>
      <li><b>NPK Ratio:</b> ${rec.npk}</li>
      <li><b>Application Schedule:</b> ${rec.schedule}</li>
      <li><b>Organic Alternative:</b> ${rec.organic}</li>
    </ul>
    <p>${soilAdjust}</p>
  `;

  chartCanvas.style.display = "block";
  downloadBtn.style.display = "inline-block";

  if (fertilizerChart) fertilizerChart.destroy();

  fertilizerChart = new Chart(chartCanvas, {
    type: "bar",
    data: {
      labels: ["Nitrogen (N)", "Phosphorus (P)", "Potassium (K)"],
      datasets: [{
        label: "Nutrient Ratio",
        data: npkValues,
        backgroundColor: ["#66bb6a", "#ffee58", "#42a5f5"],
        borderColor: ["#388e3c", "#fbc02d", "#1e88e5"],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: "Nutrient Level (kg/acre)", color: "#444" }
        }
      },
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: "NPK Ratio Visualization",
          color: "#2e7d32",
          font: { size: 16, weight: "bold" }
        }
      }
    }
  });

  // 📄 Handle PDF download
  downloadBtn.onclick = async () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    // Title
    pdf.setFontSize(18);
    pdf.setTextColor(34, 139, 34);
    pdf.text("Fertilizer Recommendation Report", 20, 20);

    pdf.setFontSize(12);
    pdf.setTextColor(0, 0, 0);

    pdf.text(`Crop: ${crop}`, 20, 40);
    pdf.text(`Soil Type: ${soil}`, 20, 50);
    pdf.text(`Soil pH: ${ph}`, 20, 60);
    pdf.text(`NPK Ratio: ${rec.npk}`, 20, 70);
    pdf.text(`Schedule: ${rec.schedule}`, 20, 80);
    pdf.text(`Organic Alternative: ${rec.organic}`, 20, 90);
    pdf.text(`${soilAdjust}`, 20, 100);

    // Add Chart Image
    const chartImage = chartCanvas.toDataURL("image/png", 1.0);
    pdf.addImage(chartImage, "PNG", 20, 110, 170, 80);

    pdf.save(`Fertilizer_Recommendation_${crop}.pdf`);
  };
}

  // Initialize map
  const map = L.map('map').setView([20.5937, 78.9629], 5); // default India center

  // OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const markersLayer = L.layerGroup().addTo(map);

  // 📍 Try to get user location
  map.locate({ setView: true, maxZoom: 13 })
    .on('locationfound', e => {
      const { latitude, longitude } = e;
      L.marker([latitude, longitude]).addTo(map)
        .bindPopup('📍 You are here').openPopup();

      // Fetch nearby services (mock data or your backend)
      loadNearbyServices(latitude, longitude);
    })
    .on('locationerror', () => {
      alert('Could not access location. Showing general map.');
      loadNearbyServices(20.5937, 78.9629);
    });

  // Mocked nearby agricultural services
  function loadNearbyServices(lat, lng) {
    const services = [
      { name: 'Green Fertilizer Store', type: 'fertilizer', lat: lat + 0.01, lng: lng + 0.01 },
      { name: 'Central Mandi Market', type: 'mandi', lat: lat - 0.008, lng: lng + 0.012 },
      { name: 'Fresh Cold Storage', type: 'coldStorage', lat: lat + 0.006, lng: lng - 0.009 },
      { name: 'Krishi Kendra Office', type: 'krishiKendra', lat: lat - 0.007, lng: lng - 0.011 }
    ];

    markersLayer.clearLayers();
    services.forEach(s => addServiceMarker(s));
    addLegend();
  }

  // 🧭 Add markers with emojis
  function addServiceMarker(svc) {
    const emojiMap = {
      fertilizer: '🛒',
      mandi: '🏪',
      coldStorage: '🧊',
      krishiKendra: '🌾'
    };
    const marker = L.marker([svc.lat, svc.lng]).addTo(markersLayer);
    marker.bindPopup(`<strong>${emojiMap[svc.type] || ''} ${svc.name}</strong><br>Type: ${svc.type}`);
  }

  // 🗺️ Add legend
  function addLegend() {
    const legend = L.control({ position: 'bottomleft' });
    legend.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <div><span>🛒</span> Fertilizer Shop</div>
        <div><span>🏪</span> Mandi Market</div>
        <div><span>🧊</span> Cold Storage</div>
        <div><span>🌾</span> Krishi Kendra</div>
      `;
      return div;
    };
    legend.addTo(map);
  }
  // 💬 Chatbot Integration

  const webhookURL = "";//<---link to your AI chatbot webhook

  const chatBtn = document.getElementById('chatbot-btn');
  const chatWindow = document.getElementById('chatbot-window');
  const sendBtn = document.getElementById('send-btn');
  const userInput = document.getElementById('user-input');
  const chatMessages = document.getElementById('chat-messages');

  chatBtn.addEventListener('click', () => {
    chatWindow.style.display = chatWindow.style.display === 'none' ? 'flex' : 'none';
  });

  sendBtn.addEventListener('click', sendMessage);
  userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

  async function sendMessage() {
    const message = userInput.value.trim();
    if (!message) return;

    appendMessage('user', message);
    userInput.value = '';

    try {
      const response = await fetch(webhookURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });

      const data = await response.json();
      appendMessage('bot', data.reply || "Sorry, I didn’t understand that.");
    } catch (err) {
      appendMessage('bot', "⚠️ Unable to connect to AI chatbot server.");
      console.error(err);
    }
  }

  function appendMessage(sender, text) {
    const msg = document.createElement('div');
    msg.className = sender === 'user' ? 'msg-user' : 'msg-bot';
    msg.textContent = text;
    chatMessages.appendChild(msg);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  
  </script>
</body>
</html>
